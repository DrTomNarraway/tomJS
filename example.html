
<!DOCTYPE html>
<html>
<body>
    <script src="jatos.js" id="jatos"></script>
    <script src="tomJS.js" id="tomJS"></script>
    <script>

        // define constants ====================================================================================================

        const BLOCK_REPS = 2 ; // 16;
        const CONDITION  = [200, 400, 600]; // target-signal SOA, milliseconds.
        const DIFFICULTY = [0.01, 0.03, 0.50]; // gabor contrast, percentage.
        const GABOR_REPS = 3; // 5; // number of trial reps in gabor training block.
        const ITI_DUR    = [800, 1000, 1200]; // duration of blank screen shown after each trial, milliseconds.
        const TEST_REPS  = 1; // 3; // number of trial reps in test blocks.
        const TIME_REPS  = 3; // 9; // number of trial reps in timing training block.

        // set up experiment ===================================================================================================

        const args = {
            'fullscreen' : false,
            'verbose': true,
            'gridlines': false
        };

        const vrs_obligs = "The success of scientific studies depends significantly on your cooperation." +
            " We therefore ask you to remain focused and to work according to the instructions throughout the entire study." +
            " In order to demonstrate your focus you must respond at the indicated time on at least 60% of trials;" +
            " and you must respond correctly on at least 60% of trials." +
            " If you wish to withdraw consent to the use of your data you are obligated to message or email Tom Narraway at the moment of your decision."
        updateConsentForm('value', 'Obligations', vrs_obligs);

        const tomJS = new Experiment(args);

        if (jatos.constructor != HTMLScriptElement) jatos.onConnected(() => { tomJS.connectToJatos(false) });

        const A = tomJS.controls.key_a_upper;
        const B = tomJS.controls.key_b_upper;

        const max_cond = arrayMax(CONDITION);
        const min_cond = arrayMin(CONDITION);
        const max_diff = arrayMax(DIFFICULTY);
        const min_diff = arrayMin(DIFFICULTY);

        const fontSize = Math.round(0.05 * tomJS.visual.stimulus_size) + "px";

        // trial arguments =====================================================================================================

        const _blockwise = {};

        const _trialwise = {
            'condition': CONDITION,
            'difficulty': DIFFICULTY,
            'target': ['A', 'B'],
        };

        const _additional = {
            'stimulus': Gabor,
            'gp_ori': 2,
            'iti_duration': ITI_DUR,
            'progress_bar_type': GuitarHeroBar,
        };

        const _conditional = {};

        const _gabor_training_trialwise = {
            'difficulty': DIFFICULTY,
            'target': ['A', 'B'],
        };

        const _gabor_training_additional = {
            'stimulus': Gabor,
            'gp_ori': 2,
            'iti_duration': ITI_DUR,
        };

        const _gabor_training_conditional = {};

        const _timing_training_trialwise = {
            'condition': CONDITION,
            'target': ['A', 'B'],
        };

        const _timing_training_additional = {
            'stimulus': Text,
            'iti_duration': ITI_DUR,
            'progress_bar_type': GuitarHeroBar,
        };

        const _timing_training_conditional = {
            'text': { '~this.args.target~ == A': '~A~', '~this.args.target~ == B': '~B~' },
        };

        // slides ==============================================================================================================

        const _consent = new Consent({'fullscreen_on_exit':true});

        const _credit_card = new CreditCard();

        const _demographics = new Demographics();

        const _keyboard = new Slide([
            { 'class': 'text', 'text': 'Please press ' + A + ' and then ' + B + ' a few times to make sure your', 'y': 0.25 },
            { 'class': 'text', 'text': 'keyboard is being read by the experiment correctly.', 'y': 0.30 },
            { 'class': 'text', 'text': '~tomJS.key~', 'upper': true, 'fontSize': fontSize },
            { 'class': 'text', 'text': 'Press ' + A + ' and ' + B + ' to continue.', 'y': 0.75 },
        ]);

        const _procedure = new Slide([
            { 'class': 'text', 'text': 'During the experiment you will perform blocks of trials. After each block you will', 'y': 0.25 },
            { 'class': 'text', 'text': 'take a short break and receive some feedback on your performance thus far.', 'y': 0.30 },
            { 'class': 'text', 'text': 'Most participants take between 50 and 60 minutes to complete this experiment.', 'y': 0.35 },
            { 'class': 'text', 'text': 'Press ' + A + ' and ' + B + ' to continue.', 'y': 0.75 },
        ]);

        // gabor training ------------------------------------------------------------------------------------------------------

        const _gabor = new Slide([
            { 'class': 'text', 'text': 'On each trial you will see a stimulus like the one below. The stimulus will be leaning to the left or right.', 'y': 0.25 },
            { 'class': 'text', 'text': 'For the first block your task is to press ' + A + ' if you think the answer is left or ' + B + ' if you think it is right.', 'y': 0.30 },
            { 'class': 'text', 'text': 'You can press ' + A + ' or ' + B + ' now to see examples of each.', 'y': 0.35 },
            { 'class': 'gabor', 'gp_size': 0.5, 'difficulty': max_diff, 'gp_ori': 2, 'gp_y': 0.55 },
            { 'class': 'text', 'text': 'Press ' + A + ' and ' + B + ' to start the first training block.', 'y': 0.75 },
        ]);

        const _gabor_end_block = new EndBlock([
            { 'class': 'text', 'text': 'End of stimulus practice. Please take a short break.', 'y': 0.25 },
            { 'class': 'text', 'text': 'Your accuracy was great!', 'conditions': ['~this.data.accuracy~ >= 80'] },
            { 'class': 'text', 'text': 'Your accuracy was good.', 'conditions': ['~this.data.accuracy~ < 80', '~this.data.accuracy~ >= 60'] },
            { 'class': 'text', 'text': 'You must improve your accuracy.', 'conditions': ['~this.data.accuracy~ < 60'] },
            { 'class': 'text', 'text': 'Press ' + A + ' and ' + B + ' to continue.', 'y': 0.75 }
        ]);

        // response signal training --------------------------------------------------------------------------------------------

        const _timing = new ExampleProgressBar([
            { 'class': 'text', 'text': 'From now on you will see a bar at the top of the screen like the example below.', 'y': 0.25 },
            { 'class': 'text', 'text': 'You need to respond while the bar is inside the indicated area.', 'y': 0.30 },
            { 'class': 'text', 'text': 'The bar and the area will also turn blue to make this easier to notice.', 'y': 0.35 },
            { 'class': 'text', 'text': 'For the next block press the indicated letter while the bar is inside the area.', 'y': 0.40 },
            { 'class': 'text', 'text': 'Press ' + A + ' and ' + B + ' to start the second training block.', 'y': 0.75 },
        ], 
            { 'progress_bar_type': GuitarHeroBar, 'signal_on': 0.80, 'signal_off':1.00 });

        const _timing_end_block = new EndBlock([
            { 'class': 'text', 'text': 'End of timing practice. Please take a short break.', 'y': 0.25 },
            { 'class': 'text', 'text': 'Your timing was great!', 'y': 0.48, 'conditions': ['~this.data.hits~ >= 80'] },
            { 'class': 'text', 'text': 'Your timing was good.', 'y': 0.48, 'conditions': ['~this.data.hits~ < 80', '~this.data.hits~ >= 60'] },
            { 'class': 'text', 'text': 'You must improve your timing.', 'y': 0.48, 'conditions': ['~this.data.hits~ < 60'] },
            { 'class': 'text', 'text': 'Press ' + A + ' and ' + B + ' to continue.', 'y': 0.75 }
        ]);

        // main experiment -----------------------------------------------------------------------------------------------------

        const _main = new ExampleProgressBar([
            { 'class': 'text', 'text': 'From now on you must respond to the tilt of the stimulus as soon as the bar goes blue.', 'y': 0.25 },
            { 'class': 'text', 'text': 'This experiment is designed to have some very hard and some very easy trials.', 'y': 0.30 },
            { 'class': 'text', 'text': 'The difficulty of the task was set according to the performance of other Prolific participants.', 'y': 0.35 },
            { 'class': 'text', 'text': 'Press ' + A + ' and ' + B + ' to start the experiment.', 'y': 0.75 },
        ], false, { 'max': 3000 });

        const _end_block = new EndBlock([
            { 'class': 'text', 'text': 'End of block. Please take a short break.', 'y': 0.25 },
            { 'class': 'text', 'text': 'Your accuracy was great!', 'y': 0.48, 'conditions': ['~this.data.accuracy~ >= 80'] },
            { 'class': 'text', 'text': 'Your accuracy was good.', 'y': 0.48, 'conditions': ['~this.data.accuracy~ < 80', '~this.data.accuracy~ >= 60'] },
            { 'class': 'text', 'text': 'You must improve your accuracy.', 'y': 0.48, 'conditions': ['~this.data.accuracy~ < 60'] },
            { 'class': 'text', 'text': 'Your timing was great!', 'y': 0.52, 'conditions': ['~this.data.hits~ >= 80'] },
            { 'class': 'text', 'text': 'Your timing was good.', 'y': 0.52, 'conditions': ['~this.data.hits~ < 80', '~this.data.hits~ >= 60'] },
            { 'class': 'text', 'text': 'You must improve your timing.', 'y': 0.52, 'conditions': ['~this.data.hits~ < 60'] },
            { 'class': 'text', 'text': 'Press ' + A + ' and ' + B + ' to continue.', 'y': 0.75 },
        ]);

        const _end_exp = new EndExperiment([
            { 'class': 'text', 'text': 'End of Experiment. Thank you for your help.', 'y': 0.25 },
            { 'class': 'text', 'text': 'You were correct on ~this.data.accuracy~% of all test trials.', 'y': 0.48 },
            { 'class': 'text', 'text': 'You responded on time on ~this.data.hits~% of all test trials.', 'y': 0.52 },
            { 'class': 'text', 'text': 'Press ' + A + ' and ' + B + ' to end the experiment.', 'y': 0.75 },
        ]);

        // timeline ============================================================================================================

        tomJS.appendToTimeline(_consent);
        tomJS.appendToTimeline(_credit_card);
        tomJS.appendToTimeline(_demographics);
        tomJS.appendToTimeline(_keyboard);
        tomJS.appendToTimeline(_procedure);

        tomJS.appendToTimeline(_gabor);
        tomJS.appendBlock(
            trial_type = Trial,
            trialwise = _gabor_training_trialwise,
            additional = _gabor_training_additional,
            conditional = _gabor_training_conditional,
            trial_reps = GABOR_REPS,
            start_slide = null,
            end_slide = _gabor_end_block,
            add_countdown = true
        );

        tomJS.appendToTimeline(_timing);
        tomJS.appendBlock(
            trial_type = ProgressBarResponseSignal,
            trialwise = _timing_training_trialwise,
            additional = _timing_training_additional,
            conditional = _timing_training_conditional,
            trial_reps = TIME_REPS,
            start_slide = null,
            end_slide = _timing_end_block,
            add_countdown = true
        );

        tomJS.appendToTimeline(_main);
        tomJS.appendBlocks(
            trial_type = ProgressBarResponseSignal,
            blockwise = _blockwise,
            trialwise = _trialwise,
            additional = _additional,
            conditional = _conditional,
            block_reps = BLOCK_REPS,
            trial_reps = TEST_REPS,
            start_slide = null,
            end_slide = _end_block,
            add_countdown = true,
        )

        tomJS.replaceEndBlockWithEndExperiment(_end_exp);

        // run =================================================================================================================

        tomJS.start();

    </script>
</body>
</html>
